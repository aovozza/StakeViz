<html>
<head>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="http://visjs.org/dist/vis.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="http://visjs.org/dist/vis.css" type="text/css" />
  <style type="text/css">
    #mynetwork {
        width: 49%;
        height: 700px;
        border: 1px solid lightgray;
        float: left;
    }
    #extraInfoContainer {
        width: 49%;
        height: 700px;
        border: 1px solid lightgray;
        display: block;
        overflow-x: auto;
    }
    #filterContainer {
        width: 98%;
    }
    #metricsTable {
        height: 100%;
        display: block;
        overflow-x: auto;
    }
    #fileSelectDialog {
        padding: 0;
        padding-top: 5px;
    }
    .issueTypeFilter {
        margin: 10px;
        margin-left: 0;
    }
    h1 {
        text-align: center;
    }
    
    .ui-dialog-titlebar-close {
        display: none;
    }
  </style>
</head>
<body>
<div id="mynetwork"></div>
<div id="extraInfoContainer">
    <h1 style="display:none;"></h1>
    <table id="metricsTable"></table>
</div>
<div id="filterContainer">
    <h2>Time Filter: <input type="text" id="timeRange" readonly ></h2><div id="timeFilter"></div>
    <h2>Issue Type Filter: </h2>
    <fieldset>
      <legend>Select Issue Types: </legend>
      <label for="type1">Issue Type 1</label>
      <input class="checkboxradio" type="checkbox" name="type1" id="type1" checked>
      <label for="type2">Issue Type 2</label>
      <input class="checkboxradio" type="checkbox" name="type2" id="type2" checked>
      <label for="type3">Issue Type 3</label>
      <input class="checkboxradio" type="checkbox" name="type3" id="type3" checked>
    </fieldset>
</div>
<div id="fileSelectDialog" class="dialog" title="File Selector">
  <form action="#">
    <fieldset>
      <label for="fileNameSelector">Select a file</label>
      <select name="fileName" id="fileNameSelector" class="selectmenu">
      </select>
    </fieldset>
  </form>
</div>
<script type="text/javascript">
    var desiredMetricColumns;
    var gephiImported;
    var container = document.getElementById('mynetwork');
    var nodes = new vis.DataSet();
    var edges = new vis.DataSet();
    var data = { nodes: nodes, edges: edges };
    var options;
    var network;
    var doubleClickTime = 0;
    var threshold = 200;
    
    initialize();
    
    function initialize() {
        desiredMetricColumns = ["organization", "degreeOutBinary", "degreeOut", "degreeInBinary", "degreeIn"];

        $( "#timeFilter" ).slider({
          range: true,
          min: 0,
          max: 100,
          values: [ 75, 99 ],
          slide: function( event, ui ) {
            $( "#timeRange" ).val( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
          }
        });
        $( "#timeRange" ).val( $( "#timeFilter" ).slider( "values", 0 ) +
          " - " + $( "#timeFilter" ).slider( "values", 1 ) );

        $( "input.checkboxradio" ).checkboxradio();
        
        $.get("http://localhost:8080/potentialFiles", function(data, status, jqXHR){
            var newdata = data.slice(2,-2).split("', '");
            $.each(data.slice(2,-2).split("', '"), function(index, file){
                $("#fileNameSelector").append("<option>" + file.slice(0,-5) + "</option>");
            });
        });
        
        $( ".dialog" ).dialog({
            modal: true
        });
        
        $( "select.selectmenu" )
                .selectmenu()
                .on("selectmenuselect", function(event, ui) {
                    $(event.currentTarget).parents(".dialog").dialog("close");
                    initializeNetwork(ui.item.value);
        });
    }
    
    function initializeNetwork(selection) {
        $.getJSON("http://localhost:8080/" + selection + ".json", function(data, status, jqXHR){
            redrawAll(JSON.parse(jqXHR.responseText));
        });

        $.getJSON("http://localhost:8080/" + selection + "_metrics.json", function(data, status, jqXHR){
            buildMetricsTable(JSON.parse(jqXHR.responseText));
        });
        
        setupDefaultOptions();

        network = new vis.Network(container, data, options);

        network.fit();

        network.on('click', handleClick);

        network.on('doubleClick', function(selectionData){
            doubleClickTime = new Date();
            if(selectionData.nodes.length !== 0){
                getHierarchy(selectionData);
            }
        });

        network.on('selectEdge', displayEdgeData);
        
        $("#metricsTable").on("click", function(data){
            var dataJq = $(data.target);
            var node = nodes.get(dataJq.html());
            
            addBackRemovedEdgesAndNodes(node);
            
            if(node !== null){
                removeUnconnectedMembers(node);
            }
            
            resetExtraInfo();
            filterTable(node);
        });
    }
    
    function displayEdgeData(selectionData) {
        if(selectionData.nodes.length === 0 && selectionData.edges.length === 1) {
            $("#metricsTable").css("display","none");
            
            var edge = edges.get(selectionData.edges[0]);
            var header = $("#extraInfoContainer h1");
            header.text(edge.from + " vs. " + edge.to);
            header.css("display","");
        }
    }
    
    function buildMetricsTable(metricsJSON){
        // EXTRACT VALUE FOR HTML HEADER.
        var col = [];
        for (var i = 0; i < metricsJSON.length; i++) {
            for (var key in metricsJSON[i]) {
                if (col.indexOf(key) === -1 && desiredMetricColumns.indexOf(key) !== -1) {
                    col.push(key);
                }
            }
        }

        // CREATE DYNAMIC TABLE.
        var table = document.getElementById("metricsTable");

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < metricsJSON.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = metricsJSON[i][col[j]];
            }
        }
    }
    
    function redrawAll(gephiJSON) {
        if (gephiJSON.nodes === undefined) {
            gephiJSON = gephiImported;
        }
        else {
            gephiImported = gephiJSON;
        }

        nodes.clear();
        edges.clear();

        var parsed = vis.network.gephiParser.parseGephi(gephiJSON); 

        parsed.edges.forEach(function(e){
            e.label = e.label.substr(0,4);
        });
        // add the parsed data to the DataSets
        nodes.add(parsed.nodes);
        edges.add(parsed.edges);
    }
    
    var removedEdges = [];
    var removedNodes = [];
    function removeUnconnectedMembers(mainNode){
        var safeNodes = new Set([]);
        var edgeArray = edges.get();
        for(i = 0; i < edgeArray.length; i++){
            var edge = edgeArray[i];
            if(mainNode.id !== edge.from && mainNode.id !== edge.to){
                edges.remove(edge.id);
                removedEdges.push(edge);
            }else{
                safeNodes.add(edge.from);
                safeNodes.add(edge.to);
            }
        }
        var nodeArray = nodes.get();
        for(i = 0; i < nodeArray.length; i++){
            if(!safeNodes.has(nodeArray[i].id)){
                nodes.remove(nodeArray[i].id);
                removedNodes.push(nodeArray[i]);
            }
        }
    }
    
    function addBackRemovedEdgesAndNodes(forNode){
        if(forNode === undefined) {
            edges.add(removedEdges);
            removedEdges = [];
        }else {
            var stillRemovedEdges = [];
            for(i = 0; i < removedEdges.length; i++){
                if(removedEdges[i].from === forNode.id || removedEdges[i].to === forNode.id){
                    edges.add(removedEdges[i]);
                }else {
                    stillRemovedEdges.push(removedEdges[i]);
                }
            }
            removedEdges = stillRemovedEdges;
        }
        
        nodes.add(removedNodes);
        removedNodes = [];
    }
    
    function handleClick(selectionData){
        var t0 = new Date();
        if (t0 - doubleClickTime > threshold) {
            setTimeout(function () {
                if (t0 - doubleClickTime > threshold) {
                    doClick(selectionData);
                }
            },threshold);
        }
    }
    
    function doClick(selectionData) {
        if(!(selectionData.edges.length === 1 && selectionData.nodes.length === 0 && options.layout.hierarchical.enabled)){
            setupDefaultOptions();
            network.setOptions(options);
        }
        if(selectionData.nodes.length === 0 && selectionData.edges.length === 0){
            addBackRemovedEdgesAndNodes();
            resetExtraInfo();
            filterTable(null);
        }else if(selectionData.nodes.length !== 0){
            var selectedNode = nodes.get(selectionData.nodes[0]);
            addBackRemovedEdgesAndNodes(selectedNode);
            removeUnconnectedMembers(selectedNode);
            resetExtraInfo();
            filterTable(selectedNode);
        }
    }
    
    function filterTable(selectedNode){
        var rows = $("#metricsTable > tbody > tr:not(:first-child)");
        rows.css("display", "");
        rows.css("font-weight", "");
        
        var orgTds = rows.children("td:first-child");
        
        $.each(orgTds, function(index, orgTd) {
            var nodeArray = nodes.get();
            var orgTdJq = $(orgTd);
            var safe = false;
            for(i = 0; i < nodeArray.length; i++){
                if(nodeArray[i].id === orgTdJq.html()){
                    safe = true;
                    break;
                }
            }
            if(!safe){
                orgTdJq.parent().css("display", "none");
            }else if(selectedNode !== null && orgTdJq.html() === selectedNode.id){
                orgTdJq.parent().css("font-weight", "bold");
            }
        });
    }
    
    function resetExtraInfo(){
        $("#extraInfoContainer h1").css("display","none");
        $("#metricsTable").css("display","");
    }
    
    function getHierarchy(selectionData){
        var mainNode = nodes.get(selectionData.nodes[0]);
        for(e in network.body.edges){
            var edge = edges.get(e);
            if(edge !== null && mainNode.id !== edge.from){
                edges.remove(e);
                removedEdges.push(edge);
            }
        }
        var hierarchOptions = options;
        hierarchOptions.layout = {
          hierarchical: {
            enabled: true,
            sortMethod: 'directed'
          }
        };
        hierarchOptions.edges.font.align = 'horizontal';
        
        network.setOptions(hierarchOptions);
    }
    
    function setupDefaultOptions(){
        options = {
            nodes: {borderWidth: 0, font: { color: '#FFF', size: 27 }},
            edges: {arrows: {to: {enabled: true}}, font: {size: 20, align: 'top'}},
            interaction: {hideEdgesOnDrag: true},
            physics: {
                forceAtlas2Based: {
                  gravitationalConstant: -36,
                  springLength: 150,
                  damping: 0.46,
                  avoidOverlap: 0.04
                },
                maxVelocity: 29,
                minVelocity: 1.45,
                solver: "forceAtlas2Based"
              },
            layout: {hierarchical: {enabled: false}}
        };
    }
</script>
</body>
</html>